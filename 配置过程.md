# 给 Linux 内核添加 MMIO patch

## 1 说明

为了追踪 kernel launch 在内核的调用逻辑，使用 MMIO Trace 工具

但是由于：

> Unfortunately the legacy ISA address range `0xa0000 - 0x100000` cannot be traced this way because marking those pages as not present crashes the kernel. 

所以尝试给 linux 内核添加 patch 来修改这个问题。

## 2 [linux-kernel - RFC PATCH v2 x86: mmiotrace - trace memory mapped IO (openwall.net)](https://lists.openwall.net/linux-kernel/2008/01/31/348)

首先在本地虚拟机上测试

安装必要的工具：

```bash
sudo apt-get update
sudo apt-get install build-essential kernel-package libncurses5-dev bison flex libssl-dev
```

注：kernel-package 这个包在 Ubuntu22.04 被移除了

获取 linux 内核源代码：

```bash
sudo apt-get source linux-image-$(uname -r)
```

遇到报错，进入 `/etc/apt/sources.list`，取消注释 deb-src 开头的行

## 3 尝试 SystemTap

```bash
sudo apt-get update
sudo apt-get install systemtap

echo "deb http://ddebs.ubuntu.com $(lsb_release -cs) main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list.d/ddebs.list
echo "deb http://ddebs.ubuntu.com $(lsb_release -cs)-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list.d/ddebs.list
echo "deb http://ddebs.ubuntu.com $(lsb_release -cs)-proposed main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list.d/ddebs.list

sudo apt-key del C8CAB6595FDFF622
wget -qO - http://ddebs.ubuntu.com/dbgsym-release-key.asc | sudo apt-key add -
sudo apt-get update
sudo apt-get install linux-image-$(uname -r)-dbgsym
sudo apt-get install gcc
sudo apt-get install binutils
sudo apt-get install build-essential linux-headers-$(uname -r)
```



### ioremap